---layout: posttitle: Building code on Mahuika - the Cray CS Programming Environmentpermalink: /lessons/maui-and-mahuika/building-code-mahuikachapter: maui-and-mahuika---## ObjectivesYou will learn:* how to compile code (Fortran, C, C++) * how to link against libraries* using the Cray Programming Environment (compiler drivers)The example programs used in this lesson can be found in the  [_code](https://github.com/nesi/hpc_training/tree/gh-pages/_code) directory of the "hpc_training" repository.**Content is still under development. Check back soon.**## Where to buildBuild processes can be performed on the Mahuika login nodes, ```login.mahuika.nesi.org.nz``` or through a Slurm job on the compute nodes. Please be aware, that the login nodes are limited and shared resources. Please limit the amount of processes on these nodes (avoid `make -j`, instead use `make -j 5`).## Compilers and LibrariesThree different types of compilers are available on Mahuika: CRAY, GNU, INTEL. Furthermore, various libraries are provided for MPI, IO, mathematical operations, and more. Compilers and modules are selected using **modules**, to get started, at least the following need to be loaded:|Compiler | module | MPI | Note ||---------|--------|-----|------||CRAY | ```PrgEnv-cray``` | ```cray-mvapich2``` |specific (MPI and scientific) libraries are loaded automatically ||INTEL | ```intel``` | ```impi``` | specific (MPI and MKL) libraries are loaded by default ||GNU | ```GCC``` |  ```OpenMPI``` | libraries need to be loaded manually |Thus, you select e.g. the Cray compiler by loading ```  module load PrgEnv-cray```Supported languages are Fortran, C, and C++. Therefore, the following **compiler** need to selected with respect of the programming language. We distinguish between, serial/thread and MPI parallelized code. | Language | CRAY | INTEL | GNU || ---------|------|-------|-----|| Fortran | ftn | ifort | gfortran|| Fortran + MPI | ftn | mpiifort | mpifort || C | cc | icc | gcc || C + MPI | cc | mpiicc | mpicc || C++ | CC | mpiicpc | mpicxx |**Note**, Cray uses compiler wrapper which are described [later in more detail](#cray-programming-environment). In general you then compile your code using:```  <compiler> <arguments> <source-file>```e.g.```   ftn -O3 hello.f90```Compilers provides a long list of options to control compile, link and optimization settings. The following table provides a list of commonly used compiler **options** for the different compilers:| Group         | Cray | Intel | GNU | Notes   ||---------------|------|-------|-----|---------|| Debugging | ```-g``` or ```-G{0,1,2,fast}``` | ```-g``` or ```-debug [keyword]``` | ```-g or -g{0,1,2,3}``` | Set level of debugging information, some levels may disable certain compiler optimisations || Light compiler optimisation  | ```-O2``` | ```-O2``` | ```-O2``` | || Aggressive compiler optimisation  | ```-O3 -hfp3``` | ```-O3 -ipo``` | ```-O3 -ffast-math -funroll-loops``` | This may affect numerical accuracy || Vectorisation reports | ```-hlist=m``` | ```-qopt-report``` | ```-fopt-info-vec``` or ```-fopt-info-missed``` | || OpenMP | ```-homp``` (default) | ```-openmp``` | ```-fopenmp``` | |Additional compiler options are documented in the compiler man pages, e.g. ```man mpiifort```. **Note**, Cray uses compiler wrappers, to list the compiler options, you need to view man pages of the actual compiler.<!-- ----------------------------------------------------------------------------------------------------------------- Cray PrgEnv-cray, compiler wrappers, libraries...- MPI librariesLinking- own libraries (-L -l -I)- external libraries (-L -l -I) EBROOT... - static linking (with gnu or intel?)- common linker problems---------------------------------------------------------------------------------------------------------------- -->### Cray Programming EnvironmentCray provides a whole package including - compilers for Fortran, C, and C++ - libraries	- FFTW -> ```cray-fftw```	- LAPACK, ScaLAPACK, QDWH -> ```cray-libsci```	- MPI -> ```cray-mvapich```, ```cray-impi``` - modules for selecting hardware specific configurations, e.g. ```craype-broadwell```, and  - tools for profiling (perftools-...) and debugging (```cray-lgdb```, ```cray-ccdb```).Compiler driver are used to compile and link the code. These automatically add options for loaded libraries and architectures and pass them through to the underlaying compiler. You can see the actual applied options by using ```-craype-verbose```. In the following the a list with compiler (drivers) and their man pages are listed:| Language | compiler driver | compiler man page ||----------|-----------------|-------------------||Fortran | ```ftn``` | ```man crayftn``` || C | ```cc``` |  ```man craycc``` || C++ | ```CC``` | ```man crayCC``` |